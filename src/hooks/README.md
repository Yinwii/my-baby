# ç»Ÿä¸€ç¼“å­˜ç®¡ç†ç³»ç»Ÿ

## ğŸ¯ è§£å†³çš„é—®é¢˜

### æ—§ç¼“å­˜ç³»ç»Ÿçš„é—®é¢˜ï¼š
1. **è·¨ç»„ä»¶ç¼“å­˜ä¸åŒæ­¥**ï¼šæ¯ä¸ªhookéƒ½æœ‰ç‹¬ç«‹çš„ç¼“å­˜ï¼Œæ•°æ®ä¿®æ”¹åå…¶ä»–ç»„ä»¶å¯èƒ½ä»æ˜¾ç¤ºæ—§æ•°æ®
2. **ç¼“å­˜å¤±æ•ˆæœºåˆ¶ä¸å®Œå–„**ï¼šåªæœ‰å½“å‰hookçš„æ“ä½œæ‰ä¼šæ¸…é™¤ç¼“å­˜ï¼Œæ— æ³•æ„ŸçŸ¥å¤–éƒ¨æ•°æ®å˜åŒ–
3. **ç¼ºä¹ç»Ÿä¸€ç®¡ç†**ï¼šé‡å¤çš„ç¼“å­˜é€»è¾‘ï¼Œéš¾ä»¥ç»´æŠ¤å’Œè°ƒè¯•
4. **å¯èƒ½å¯¼è‡´é¡µé¢ä¸æ›´æ–°**ï¼šåœ¨ç¼“å­˜æœ‰æ•ˆæœŸå†…ï¼Œå³ä½¿æœåŠ¡å™¨æ•°æ®å·²å˜åŒ–ï¼Œé¡µé¢ä»æ˜¾ç¤ºç¼“å­˜æ•°æ®

### æ–°ç³»ç»Ÿçš„ä¼˜åŠ¿ï¼š
âœ… **ç»Ÿä¸€ç¼“å­˜ç®¡ç†**ï¼šæ‰€æœ‰æ•°æ®ä½¿ç”¨åŒä¸€ä¸ªç¼“å­˜ç®¡ç†å™¨
âœ… **è·¨ç»„ä»¶åŒæ­¥**ï¼šä»»ä½•ç»„ä»¶çš„æ•°æ®æ›´æ–°éƒ½ä¼šé€šçŸ¥æ‰€æœ‰ç›¸å…³ç»„ä»¶
âœ… **æ™ºèƒ½å¤±æ•ˆæœºåˆ¶**ï¼šæ”¯æŒç²¾ç¡®å¤±æ•ˆå’Œæ¨¡å¼åŒ¹é…å¤±æ•ˆ
âœ… **äº‹ä»¶é©±åŠ¨æ›´æ–°**ï¼šç¼“å­˜å˜åŒ–æ—¶è‡ªåŠ¨é€šçŸ¥è®¢é˜…è€…
âœ… **æ›´å¥½çš„è°ƒè¯•ä½“éªŒ**ï¼šç»Ÿä¸€çš„ç¼“å­˜çŠ¶æ€ç›‘æ§

## ğŸ†• æ–°å¢åŠŸèƒ½ï¼šå®å®å¤´åƒ

### åŠŸèƒ½ç‰¹æ€§
- ğŸ–¼ï¸ **å¤´åƒä¸Šä¼ **ï¼šæ”¯æŒä¸Šä¼ å®å®ä¸“å±å¤´åƒ
- ğŸ”„ **å®æ—¶åŒæ­¥**ï¼šå¤´åƒæ›´æ–°åè‡ªåŠ¨åŒæ­¥åˆ°æ‰€æœ‰é¡µé¢
- ğŸ“± **å“åº”å¼æ˜¾ç¤º**ï¼šå¤´åƒåœ¨ä¸åŒé¡µé¢ä»¥åˆé€‚å°ºå¯¸æ˜¾ç¤º
- ğŸ¨ **ä¼˜é›…é™çº§**ï¼šæœªè®¾ç½®å¤´åƒæ—¶æ˜¾ç¤ºæ€§åˆ«å¯¹åº”çš„è¡¨æƒ…ç¬¦å·

### ä½¿ç”¨æ–¹æ³•
1. **è¿›å…¥å®å®ä¿¡æ¯é¡µé¢**
2. **ç‚¹å‡»"æ›´æ¢å¤´åƒ"æŒ‰é’®**
3. **é€‰æ‹©å›¾ç‰‡æ–‡ä»¶**ï¼ˆæ”¯æŒå¸¸è§å›¾ç‰‡æ ¼å¼ï¼‰
4. **é¢„è§ˆç¡®è®¤**åç‚¹å‡»"æ›´æ–°å¤´åƒ"
5. **å¤´åƒç«‹å³åœ¨Dashboardç­‰é¡µé¢ç”Ÿæ•ˆ**

### æŠ€æœ¯å®ç°
- åˆ©ç”¨ç°æœ‰çš„ç…§ç‰‡ä¸Šä¼ æ¥å£ `/api/photos/upload`
- æ•°æ®åº“æ–°å¢ `avatar` å­—æ®µå­˜å‚¨å¤´åƒURL
- ç¼“å­˜ç³»ç»Ÿè‡ªåŠ¨å¤„ç†è·¨ç»„ä»¶åŒæ­¥
- Next.js Imageç»„ä»¶ä¼˜åŒ–å›¾ç‰‡åŠ è½½

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. åŸºæœ¬æ•°æ®è·å–
```typescript
import { useCache } from './useCacheManager'

// æ›¿ä»£æ—§çš„useState + useEffectæ¨¡å¼
const { data, loading, error, refetch } = useCache(
  'cache-key',
  async () => {
    // æ•°æ®è·å–é€»è¾‘
    const response = await fetch('/api/data')
    return response.json()
  },
  {
    duration: 5 * 60 * 1000, // ç¼“å­˜5åˆ†é’Ÿ
    autoRefresh: true, // ç»„ä»¶æŒ‚è½½æ—¶è‡ªåŠ¨è·å–æ•°æ®
    dependencies: [babyId] // ä¾èµ–å˜åŒ–æ—¶é‡æ–°è·å–
  }
)
```

### 2. æ•°æ®æ›´æ–°ä¸ç¼“å­˜å¤±æ•ˆ
```typescript
import { useCacheInvalidation } from './useCacheManager'

const { invalidate, invalidatePattern, invalidateBabyData } = useCacheInvalidation()

// åˆ›å»ºæ•°æ®å
const createRecord = async (data) => {
  const result = await fetch('/api/records', { method: 'POST', ... })
  
  // å¤±æ•ˆç›¸å…³ç¼“å­˜
  invalidate(`records-${babyId}`) // å¤±æ•ˆç‰¹å®šç¼“å­˜
  invalidateBabyData(babyId) // å¤±æ•ˆbabyç›¸å…³çš„æ‰€æœ‰ç¼“å­˜
  
  return result
}
```

### 3. ç°æœ‰hookçš„ä½¿ç”¨ï¼ˆå·²æ›´æ–°ï¼‰
```typescript
// useBaby - ç°å·²åŒ…å«å¤´åƒæ”¯æŒ
const { baby, loading, error, refetch, updateBaby } = useBaby()

// æ›´æ–°å¤´åƒ
await updateBaby({
  id: baby.id,
  avatar: 'https://example.com/avatar.jpg'
})

// useGrowthRecords
const { records, loading, error, refetch, createRecord } = useGrowthRecords(babyId)

// useMilestones
const { milestones, loading, error, refetch, createMilestone } = useMilestones(babyId)

// usePhotos
const { mediaItems, loading, error, fetchPhotos, uploadPhoto } = usePhotos(babyId)
```

## ğŸ› ï¸ ç¼“å­˜ç®¡ç†åŠŸèƒ½

### ç²¾ç¡®å¤±æ•ˆ
```typescript
// å¤±æ•ˆç‰¹å®šç¼“å­˜
invalidate('growth-records-123')
```

### æ¨¡å¼åŒ¹é…å¤±æ•ˆ
```typescript
// å¤±æ•ˆæ‰€æœ‰babyç›¸å…³ç¼“å­˜
invalidatePattern('baby-123')
invalidatePattern(/^growth-records-.*/)
```

### æ‰¹é‡å¤±æ•ˆ
```typescript
// å¤±æ•ˆç‰¹å®šbabyçš„æ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬å¤´åƒï¼‰
invalidateBabyData(babyId) // ä¼šå¤±æ•ˆï¼š
// - baby-{babyId} (åŒ…å«å¤´åƒä¿¡æ¯)
// - growth-records-{babyId}
// - milestones-{babyId}
// - photos-{babyId}
```

### å…¨å±€æ¸…é™¤
```typescript
// æ¸…é™¤æ‰€æœ‰ç¼“å­˜
clearAll()
```

## ğŸ“Š ç¼“å­˜çŠ¶æ€ç›‘æ§

```typescript
import { useCacheStatus } from './useCacheManager'

const { totalEntries, lastUpdated } = useCacheStatus()
```

## ğŸ”„ æ•°æ®é¢„åŠ è½½

```typescript
import { useDashboardPreloader, useSmartPreloader } from './useDataPreloader'

// Dashboardé¢„åŠ è½½
const { preloadData, isReady } = useDashboardPreloader()

// æ™ºèƒ½é¢„åŠ è½½
const { clearInactiveCache } = useSmartPreloader(activeTab, loadedTabs)
```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. ç¼“å­˜é”®å‘½åè§„èŒƒ
- ä½¿ç”¨æè¿°æ€§çš„é”®åï¼š`growth-records-${babyId}`
- ä¿æŒä¸€è‡´çš„å‘½åæ¨¡å¼ï¼š`{resource}-{identifier}`
- é¿å…é”®åå†²çª

### 2. ç¼“å­˜æ—¶é—´ç­–ç•¥
- é¢‘ç¹å˜åŒ–çš„æ•°æ®ï¼š1-2åˆ†é’Ÿ
- ç›¸å¯¹ç¨³å®šçš„æ•°æ®ï¼š5-10åˆ†é’Ÿ
- é™æ€æ•°æ®ï¼ˆå¦‚å¤´åƒï¼‰ï¼š30åˆ†é’Ÿæˆ–æ›´é•¿

### 3. å¤±æ•ˆç­–ç•¥
- æ•°æ®åˆ›å»º/æ›´æ–°/åˆ é™¤åç«‹å³å¤±æ•ˆç›¸å…³ç¼“å­˜
- å¤´åƒæ›´æ–°åè‡ªåŠ¨å¤±æ•ˆbabyç¼“å­˜
- ä½¿ç”¨ `invalidateBabyData` è¿›è¡Œæ‰¹é‡å¤±æ•ˆ
- è°¨æ…ä½¿ç”¨ `clearAll`ï¼Œé¿å…è¿‡åº¦æ¸…é™¤

### 4. é”™è¯¯å¤„ç†
```typescript
try {
  const result = await updateBaby({ id: baby.id, avatar: newAvatarUrl })
  // æˆåŠŸåå¤±æ•ˆç¼“å­˜
  invalidate('baby')
} catch (error) {
  // é”™è¯¯å¤„ç†ï¼Œä¸è¦å¤±æ•ˆç¼“å­˜
  console.error('å¤´åƒæ›´æ–°å¤±è´¥:', error)
}
```

## ğŸ”§ è¿ç§»æŒ‡å—

### ä»æ—§ç³»ç»Ÿè¿ç§»
1. ç§»é™¤æ—§çš„ `useState` å’Œ `useEffect` æ•°æ®è·å–é€»è¾‘
2. ä½¿ç”¨ `useCache` æ›¿ä»£
3. åœ¨æ•°æ®ä¿®æ”¹æ“ä½œä¸­æ·»åŠ ç¼“å­˜å¤±æ•ˆé€»è¾‘
4. æµ‹è¯•è·¨ç»„ä»¶çš„æ•°æ®åŒæ­¥

### å…¼å®¹æ€§
- ç°æœ‰ç»„ä»¶çš„APIä¿æŒä¸å˜
- æ–°å¢å¤´åƒåŠŸèƒ½å‘åå…¼å®¹
- é€æ­¥è¿ç§»ï¼Œä¸éœ€è¦ä¸€æ¬¡æ€§ä¿®æ”¹æ‰€æœ‰ä»£ç 
- æ—§çš„ç¼“å­˜ç³»ç»Ÿå·²è¢«æ³¨é‡Šï¼Œå¯ä»¥é€æ­¥ç§»é™¤

## ğŸ“ ç¤ºä¾‹åœºæ™¯

### åœºæ™¯1ï¼šå¤´åƒæ›´æ–°åè·¨é¡µé¢åŒæ­¥
```typescript
// åœ¨BabyInfoç»„ä»¶ä¸­
const updateAvatar = async (avatarFile) => {
  const uploadResult = await uploadToR2(avatarFile)
  await updateBaby({
    id: baby.id,
    avatar: uploadResult.url
  })
  // Dashboardå’Œå…¶ä»–é¡µé¢çš„å¤´åƒä¼šè‡ªåŠ¨æ›´æ–°
}
```

### åœºæ™¯2ï¼šæ·»åŠ æˆé•¿è®°å½•åDashboardæ›´æ–°
```typescript
// åœ¨GrowthRecordsç»„ä»¶ä¸­
const createRecord = async (data) => {
  const result = await api.createRecord(data)
  invalidateBabyData(babyId) // Dashboardä¼šè‡ªåŠ¨æ›´æ–°ç»Ÿè®¡æ•°æ®
  return result
}
```

### åœºæ™¯3ï¼šå¤šä¸ªé¡µé¢æ˜¾ç¤ºç›¸åŒæ•°æ®
```typescript
// é¡µé¢Aå’Œé¡µé¢Béƒ½ä½¿ç”¨ç›¸åŒçš„æ•°æ®
const { baby } = useBaby() // ä¸¤ä¸ªé¡µé¢ä¼šè‡ªåŠ¨åŒæ­¥babyæ•°æ®ï¼ˆåŒ…æ‹¬å¤´åƒï¼‰çš„å˜åŒ–
```

### åœºæ™¯4ï¼šæ€§èƒ½ä¼˜åŒ–çš„é¢„åŠ è½½
```typescript
// æ ¹æ®ç”¨æˆ·è¡Œä¸ºæ™ºèƒ½é¢„åŠ è½½
const preloader = useSmartPreloader(activeTab, loadedTabs)
// å½“ç”¨æˆ·å¯èƒ½éœ€è¦æ—¶æ‰é¢„åŠ è½½ç›¸å…³æ•°æ®
```

è¿™ä¸ªç»Ÿä¸€çš„ç¼“å­˜ç®¡ç†ç³»ç»Ÿè§£å†³äº†åŸæœ‰çš„è·¨ç»„ä»¶æ•°æ®åŒæ­¥é—®é¢˜ï¼Œå¹¶æ–°å¢äº†å¤´åƒåŠŸèƒ½ï¼Œç¡®ä¿äº†æ•°æ®çš„ä¸€è‡´æ€§å’Œé¡µé¢çš„å®æ—¶æ›´æ–°ã€‚ 